name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Path filtering — skip jobs when irrelevant files change
  # ---------------------------------------------------------------------------
  changes:
    runs-on: ubuntu-24.04
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      frontend: ${{ steps.filter.outputs.frontend }}
      tauri: ${{ steps.filter.outputs.tauri }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'crates/**'
              - 'apps/server/**'
              - 'apps/desktop/src-tauri/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            frontend:
              - 'apps/desktop/src/**'
              - 'apps/desktop/package.json'
              - 'apps/desktop/tsconfig.json'
              - 'apps/desktop/vite.config.ts'
              - 'apps/desktop/vitest.config.ts'
              - 'pnpm-lock.yaml'
            tauri:
              - 'crates/**'
              - 'apps/server/**'
              - 'apps/desktop/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'pnpm-lock.yaml'

  # ---------------------------------------------------------------------------
  # Rust — formatting
  # ---------------------------------------------------------------------------
  rust-fmt:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  # ---------------------------------------------------------------------------
  # Rust — clippy
  # ---------------------------------------------------------------------------
  rust-clippy:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - run: cargo clippy --workspace -- -D warnings

  # ---------------------------------------------------------------------------
  # Rust — tests (crates without PostgreSQL)
  # ---------------------------------------------------------------------------
  rust-test:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - run: |
          cargo test -p openconv-shared
          cargo test -p openconv-crypto
          cargo test -p openconv-desktop

      - name: Check bindings.ts is up to date
        run: git diff --exit-code apps/desktop/src/bindings.ts

  # ---------------------------------------------------------------------------
  # Rust — server tests (needs PostgreSQL)
  # ---------------------------------------------------------------------------
  rust-test-server:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-24.04
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: openconv
          POSTGRES_USER: openconv
          POSTGRES_PASSWORD: openconv
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U openconv"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgres://openconv:openconv@localhost:5432/openconv
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libssl-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - run: cargo test -p openconv-server

  # ---------------------------------------------------------------------------
  # Frontend — lint & type check
  # ---------------------------------------------------------------------------
  frontend-lint:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: apps/desktop
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm run fmt:check
      - run: pnpm run lint
      - run: npx tsc --noEmit

  # ---------------------------------------------------------------------------
  # Frontend — tests
  # ---------------------------------------------------------------------------
  frontend-test:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: apps/desktop
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: pnpm test

  # ---------------------------------------------------------------------------
  # Tauri — compile check (cross-platform)
  # ---------------------------------------------------------------------------
  tauri-compile-check:
    needs: changes
    if: needs.changes.outputs.tauri == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
          - os: macos-15
          - os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      # --- System dependencies (per platform) ---
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler \
            libssl-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install protoc -y
          vcpkg install openssl:x64-windows-static-md
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static-md" >> $env:GITHUB_ENV

      # --- Toolchains ---
      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      # --- Build frontend then check Rust compilation ---
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
        working-directory: apps/desktop
      - run: cargo check -p openconv-desktop
